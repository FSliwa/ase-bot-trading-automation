#!/usr/bin/expect
set timeout 60

# Configuration
set server_ip "185.70.196.214"
set server_user "admin"

puts "ğŸ”§ Updating Trading Bot service to use FastAPI..."
puts "Enter SSH password for admin@185.70.196.214:"
stty -echo
gets stdin ssh_pass
stty echo
puts ""

puts "Enter sudo password:"
stty -echo  
gets stdin sudo_pass
stty echo
puts ""

# Connect to server
spawn ssh -o StrictHostKeyChecking=no $server_user@$server_ip
expect "password:"
send "$ssh_pass\r"
expect "$ "

# Stop current service
puts "ğŸ›‘ Stopping current service..."
send "echo '$sudo_pass' | sudo -S systemctl stop trading-bot\r"
expect "$ "

# Update systemd service file for FastAPI
puts "âš™ï¸ Updating systemd service for FastAPI..."
send "echo '$sudo_pass' | sudo -S tee /etc/systemd/system/trading-bot.service > /dev/null << 'EOF'\r"
expect "> "
send "\[Unit\]\r"
expect "> "
send "Description=Trading Bot FastAPI Server\r"
expect "> "
send "After=network.target\r"
expect "> "
send "\r"
expect "> "
send "\[Service\]\r"
expect "> "
send "Type=simple\r"
expect "> "
send "User=admin\r"
expect "> "
send "Group=admin\r"
expect "> "
send "WorkingDirectory=/opt/trading-bot\r"
expect "> "
send "Environment=PATH=/opt/trading-bot/.venv/bin\r"
expect "> "
send "EnvironmentFile=/opt/trading-bot/.env.db\r"
expect "> "
send "ExecStart=/opt/trading-bot/.venv/bin/uvicorn fastapi_app:app --host 0.0.0.0 --port 8009 --workers 1\r"
expect "> "
send "Restart=always\r"
expect "> "
send "RestartSec=10\r"
expect "> "
send "\r"
expect "> "
send "\[Install\]\r"
expect "> "
send "WantedBy=multi-user.target\r"
expect "> "
send "EOF\r"
expect "$ "

# Reload systemd and start service
puts "ğŸ”„ Reloading systemd and starting FastAPI service..."
send "echo '$sudo_pass' | sudo -S systemctl daemon-reload\r"
expect "$ "

send "echo '$sudo_pass' | sudo -S systemctl enable trading-bot\r"
expect "$ "

send "echo '$sudo_pass' | sudo -S systemctl start trading-bot\r"
expect "$ "

# Wait for service to start
puts "â³ Waiting for service to start..."
send "sleep 5\r"
expect "$ "

# Check status
puts "ğŸ“Š Checking service status..."
send "echo '$sudo_pass' | sudo -S systemctl status trading-bot --no-pager\r"
expect "$ "

# Test endpoints
puts "ğŸ§ª Testing FastAPI endpoints..."
send "curl -s -w 'Health: %{http_code}\\n' http://localhost:8009/healthz\r"
expect "$ "

send "curl -s -w 'Ready: %{http_code}\\n' http://localhost:8009/readyz\r"
expect "$ "

send "curl -s -w 'Docs: %{http_code}\\n' http://localhost:8009/docs\r"
expect "$ "

send "curl -s -w 'Metrics: %{http_code}\\n' http://localhost:8009/metrics\r"
expect "$ "

puts "âœ… Service update completed!"
send "exit\r"
expect eof
